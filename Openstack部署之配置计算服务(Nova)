### 计算服务 ###
第0部分:  计算服务组件介绍
第1部分:  安装计算服务的主控服务
第2部分:  配置计算节点

################################################ NO.0 计算服务组件介绍 ###############################################################
计算服务是云计算的基础控制器, 是iass系统的主要组成部分.利用它以创建管理云计算系统. 主要的模块使用python实现.
计算服务与Identity服务交互以获取认证,与镜像服务交互获取镜像,与dashboard交互以产生用户与管理员的操作界面.
对镜像服务的获取是收到租户与用户限制的,每个租户的配额也是有限的(例如允许创建虚拟机的数量).
计算服务(nova-compute,部署在计算节点上)在标准硬件上进行横向扩展,下载镜像以启动虚拟机.
计算服务有以下的功能区域以及组件构成:
(1)API
    nova-api服务:接收与响应终端用户的api调用.支持 openstack compute api 以及 amazon的ec2 api,以及管理员用户的特权操作;同时也初始化 orche
-stration 活动,例如,启动一个虚拟机，执行一些策略.
    nova-api-metadata服务:接受来自虚拟机的metadata请求.该服务通常用于多租户模式下的 nova-network安装;了解更多请查看 Cloud Administrator 
Guide的Metadata service.

(2)Compute core
    nova-compute服务. 一个工作于后台的进程,负责通过hypervisor(kvm,xen等)的api创建与终止虚拟机实例instances. 例如,XenAPI(用于XenServer/XCP),
libvert(用于KVM或qemu),VMwareAPI(用于VMware)等等;该进程做的工作是相当复杂的,但是基础是简单的:从队列中接受请求,然后执行一系列的系统命令,例如
启动一个KVM实例,在执行完毕后修改对应数据库状态.
    nova-scheduler服务. 概念上来说,是计算服务中最简单的部分了:从队列中取出一个虚拟机实例,决定在哪个计算节点上运行这个实例.
    nova-conductor模块. 居中调度nova-compute与database:旨在消除nova-compute对数据库的直接操作.该模块可以横向扩展.可是,不要把该模块与nova
    -compute部署在一起.

(3)Networking for VMs
    nova-network服务. 与nova-compute类似,它接受来自队列的网络任务并执行网络操作,例如设置linux bridge接口,或改动iptables规则. 现在该功能被迁
    移到OpenStack Networking组件,成为单独的OpenStack服务. 
    nova-dhcpbridge 脚本.使用dhcp-script追踪ip租约,并将其记录进数据库.现已经迁移进入OpenStack Networking. OpenStack Networking提供不同的script

(4)Console interface
    nova-consoleauth服务.向用户授予tokens(由console proxy提供).参考nova-novncproxy以及nova-xvpnvcproxy.该服务的职责是通过运行以提供 console 
    proxy 服务.根据nova-consoleauth服务运行对应的proxy.了解更多请参考 nova-consoleauth.
    nova-novncproxy服务.提供通过VNC连接访问运行实例的代理服务.支持基于浏览器的novnc客户端.
    nova-xvpnvncproxy 服务. 提供通过VNC连接访问运行实例的代理服务. 支持为openstack定制的java 客户端.
    nova-cert 服务.管理 x509 认证.

(5)Image management (EC2场景)
    nova-objectstore 服务.提供向镜像服务注册镜像的S3接口. 应用于支持euca2ools的场合.该euca2ools与该服务通过S3接口交互,该服务则负责将s3请求翻
    译成镜像服务请求.
    euca2ools 客户端.一套管理云资源的命令行翻译器.尽管不是OpenStack模块,但是可以通过配置nova-api以支持EC2接口.了解更多请查看Eucalyptus 3.4.

(6)Command-line clients and other interfaces
    nova 客户端.允许用户以终端用户或者管理员身份提交命令进行云资源管理.
    nova-manage 客户端. 允许云管理员administrators提交系统配置管理的命令.

其它组件
    消息队列.一个中央hub:在daemon之间传递消息.通常用rabbitmq实现;但是可以用任何的AMOP协议的消息队列qpid或zero mq也是OK的.
    SQL数据库. 为云基础设施存储多数创建时或运行时状态信息. 包含可用虚拟机类型,使用中的虚拟机,可用网络,租户;理论来说,OpenStack支持任何SQL
    -Alchemy所支持的数据库.但是用得最广泛的还是sqlite3,mysql.postgresql.

计算服务与其他OpenStack服务交互: (1) Identity Service (2)Image Service (3)OpenStack dashboard.

################################################ NO.1 安装计算服务的主控服务 #########################################################
实践部分:
1.安装 openstack-nova-* 组件
[root@controller ~]# yum install -y openstack-nova-api
[root@controller ~]# yum install -y openstack-nova-cert 
[root@controller ~]# yum install -y openstack-nova-conductor 
[root@controller ~]# yum install -y openstack-nova-console
[root@controller ~]# rpm -U /opt/rpms/python-websockify-0.6.0-2.el7.noarch.rpm
[root@controller ~]# rpm -ivh /opt/rpms/novnc-0.5.1-2.el7.noarch.rpm
[root@controller ~]# yum install -y openstack-nova-novncproxy
[root@controller ~]# yum install -y openstack-nova-scheduler 
[root@controller ~]# yum install -y python-novaclient

2.修改nova.conf 中数据库连接参数
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf database connection \
                                                          mysql://nova:8430e3bff4d000a04085@controller/nova

3.修改配置nova.conf中rabbitmq消息队列信息
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf DEFAULT rpc_backend rabbit
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf DEFAULT rabbit_host 10.160.0.116
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf DEFAULT rabbit_port 5672
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf DEFAULT rabbit_hosts  10.160.0.116:5672
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf DEFAULT rabbit_use_ssl false
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf DEFAULT rabbit_userid guest
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf DEFAULT rabbit_password guest
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf DEFAULT rabbit_virtual_host  /
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf DEFAULT rabbit_ha_queues false

4.修改配置文件中vncproxy相关参数
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf DEFAULT my_ip 10.160.0.116
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf DEFAULT vncserver_listen 10.160.0.116
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf DEFAULT vncserver_proxyclient_address 10.160.0.116

5.使用root用户登录数据库创建nova数据库,赋权
[root@controller ~(keystonerc_admin)]$ mysql -uroot -p
Enter password: 1428101ae612a0110bb9
MariaDB [(none)]> CREATE DATABASE nova;
MariaDB [(none)]> GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'localhost' IDENTIFIED BY '8430e3bff4d000a04085';
MariaDB [(none)]> GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'%' IDENTIFIED BY '8430e3bff4d000a04085';
MariaDB [(none)]> FLUSH PRIVILEGES;
MariaDB [(none)]> quit

6.初始化nova数据库的各种表
[root@controller ~(keystonerc_admin)]$ su -s /bin/sh -c "nova-manage db sync" nova


7.创建nova用户并添加service租户,admin角色
[root@controller ~(keystonerc_admin)]$ keystone user-create 
                        --name=nova --pass=0275aa48b1e0a313bced --email=nova@qqvps.com
+----------+----------------------------------+
| Property |              Value               |
+----------+----------------------------------+
|  email   |          nova@qqvps.com          |
| enabled  |               True               |
|    id    | 04aee8b4fb834bcdbb4e8444e559fc8a |
|   name   |               nova               |
| username |               nova               |
+----------+----------------------------------+
[root@controller ~(keystonerc_admin)]$ keystone user-role-add --user=nova --tenant=service --role=admin


8.修改配置文件中nova使用的keystone凭据信息
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf DEFAULT auth_strategy keystone
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_uri http://controller:5000
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_host controller
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_protocol http
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_port 35357
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf keystone_authtoken admin_user nova
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf keystone_authtoken admin_tenant_name service
[root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/nova/nova.conf keystone_authtoken admin_password 0275aa48b1e0a313bced

9.在keystone中注册nova服以及endpoint
[root@controller ~(keystonerc_admin)]$ keystone service-create --name=nova 
--type=compute --description="OpenStack Compute"
+-------------+----------------------------------+
|   Property  |              Value               |
+-------------+----------------------------------+
| description |        OpenStack Compute         |
|   enabled   |               True               |
|      id     | 0909ef744e014cdcb77a5cb21cda31ea |
|     name    |               nova               |
|     type    |             compute              |
+-------------+----------------------------------+

[root@controller ~(keystonerc_admin)]$ keystone endpoint-create --service-id=$(keystone service-list | \
                                           awk '/ compute / {print $2}') --publicurl=http://controller:8774/v2/%\(tenant_id\)s  \
                                           --internalurl=http://controller:8774/v2/%\(tenant_id\)s  \
                                           --adminurl=http://controller:8774/v2/%\(tenant_id\)s
+-------------+-----------------------------------------+
|   Property  |                  Value                  |
+-------------+-----------------------------------------+
|   adminurl  | http://controller:8774/v2/%(tenant_id)s |
|      id     |     61614007562340c1991a452c5ed4ca33    |
| internalurl | http://controller:8774/v2/%(tenant_id)s |
|  publicurl  | http://controller:8774/v2/%(tenant_id)s |
|    region   |                regionOne                |
|  service_id |     0909ef744e014cdcb77a5cb21cda31ea    |
+-------------+-----------------------------------------+

10.开启各个服务并设置服务的开机启动
[root@controller ~(keystonerc_admin)]$ for comp in {"api","cert","consoleauth","scheduler","conductor","novncproxy"};  \
do systemctl enable openstack-nova-${comp};systemctl start openstack-nova-${comp};done

[root@controller ~(keystonerc_admin)]$ for comp in {"api","cert","consoleauth","scheduler","conductor","novncproxy"};  \
do systemctl status openstack-nova-${comp};done

11.测试nova配置
[root@controller ~(keystonerc_admin)]$ nova image-list
+--------------------------------------+--------+--------+--------+
| ID                                   | Name   | Status | Server |
+--------------------------------------+--------+--------+--------+
| ba8251cc-618b-48c1-b15d-583032777f56 | cirros | ACTIVE |        |
+--------------------------------------+--------+--------+--------+

################################################ NO.2 配置计算节点 ###################################################################


