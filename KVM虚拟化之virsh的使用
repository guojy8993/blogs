【Disk】
(1) virsh attach-disk 
## 1.配置良好的 storage device 示范:
<disk type='file' device='disk'>
<driver name='qemu' type='qcow2'/>
<source file='/data/instance/KJtxzalrgxX9/fa24d800-3338-4b01-8c7b-e251fd973b3e'/>
<backingStore/>
<target dev='vdb' bus='virtio'/>
<alias name='virtio-disk1'/>
<address type='pci' domain='0x0000' bus='0x00' slot='0x08' function='0x0'/>
</disk>

## 2.virsh help attach-disk 帮助信息与选项说明:
[root@agent144 KY-vxlan100-A]# virsh help attach-disk
  NAME
    attach-disk - attach disk device
  SYNOPSIS
    attach-disk <domain> <source> <target> [--targetbus <string>] [--driver <string>] [--subdriver <string>]
        [--iothread <string>] [--cache <string>] [--type <string>] [--mode <string>] [--sourcetype <string>] 
        [--serial <string>] [--wwn <string>] [--rawio] [--address <string>] [--multifunction] [--print-xml] 
        [--persistent] [--config] [--live] [--current]
  DESCRIPTION
    Attach new disk device.

#必选项:虚拟机名字                [--domain] <string>  domain name, id or uuid
#必选项:新加磁盘文件完整路径      [--source] <string>  source of disk device
#必选项:新加磁盘的挂载目标        [--target] <string>  target of disk device
#可选:挂载目标的总线类型          --targetbus <string>  target bus of disk device
#可选:磁盘设备驱动                --driver <string>  driver of disk device
#可选:子驱动(raw/qcow2/cow/vmdk)  --subdriver <string>  subdriver of disk device
#可选:IOThread                    --iothread <string>  IOThread to be used by supported device
#可选:{none|writethrough|writeback}     --cache <string>  cache mode of disk device
# none:关闭缓存
# writethrough:数据写入磁盘缓存与后端设备,优点:安全 缺点:写数据速度一般 (cache默认值)
# writeback:数据写入磁盘缓存即返回,优点:写数据速度快 缺点:断电可能导致数据丢失

#可选:目标设备类型                  --type <string>  target device type
#可选:目标设备读写模式              --mode <string>  mode of device reading and writing
#可选:源文件的类型{file|block}      --sourcetype <string>  type of source (block|file)
#可选:磁盘设备的串行号              --serial <string>  serial of disk device
#可选:磁盘设备全球唯一号            --wwn <string>   wwn of disk device
# 	  wwn 即World Wide Number

#可选:是否开启裸io                  --rawio      needs rawio capability
#可选:磁盘设备地址                  --address <string>  address of disk device
#	  address选项                     --multifunction  use multifunction pci under specified address
#可选:导出加磁盘后的xml,并不真添加  --print-xml      print XML document rather than attach the disk
#可选:使热添加持久化                --persistent     make live change persistent
#可选:下次启动是否有效              --config      affect next boot
#可选:是否立即生效                  --live        affect running domain
#可选:当次生效                      --current     affect current domain


## 3.使用 virsh attach-disk 添加 qcow2 格式的镜像作为数据盘:
[root@agent144 KY-vxlan100-A]# virsh  attach-disk  --domain KY-vxlan100-A \
                                    --source /data/instance/KY-vxlan100-A/data \
                                    --target vdb \
                                    --targetbus virtio \
                                    --driver qemu  \
                                    --subdriver qcow2 \
                                    --cache writeback \
                                    --sourcetype file \
                                    --live  \
                                    --config
# 将配置文件与命令行参数对比进行学习

参考文档:
1.http://blog.chinaunix.net/uid-26000137-id-3957726.html    # qemu cache选项与说明



【Snapshot】
(1) virsh snapshot-create-as
[root@agent144 KY009]# virsh help snapshot-create-as
  NAME
    snapshot-create-as - Create a snapshot from a set of args
  SYNOPSIS
    snapshot-create-as <domain> [--name <string>] [--description <string>] [--print-xml]
    [--no-metadata] [--halt] [--disk-only] [--reuse-external] [--quiesce] [--atomic] [--live]
    [--memspec <string>] [[--diskspec] <string>]...
  DESCRIPTION
    Create a snapshot (disk and RAM) from arguments
## 虚拟机快照创建选项说明:
#必选项:虚拟机名字                [--domain] <string>  domain name, id or uuid
#可选项:快照名字                  --name <string>  name of snapshot
#可选项:快照描述信息              --description <string>  description of snapshot
#可选项:只打印xml不创建           --print-xml      print XML document rather than create
#可选项:不创建元数据              --no-metadata    take snapshot but create no metadata
#可选项:快照创建后暂停机器        --halt           halt domain after snapshot is created
#可选项:仅创建磁盘快照,不创建机器快照                    --disk-only  capture disk state but not vm state
#可选项:再利用外部文件(似乎是 external snapshot)         --reuse-external  reuse any existing external files
#可选项:客户机文件系统静默                               --quiesce        quiesce guest's file systems
#可选项:原子操作                  --atomic         require atomic operation
#可选项:热操作:                   --live           take a live snapshot
#可选项:内存选项                  --memspec <string>  memory attributes: [file=]name[,snapshot=type]
#可选项:磁盘选项                  [--diskspec] <string>  disk attributes: disk[,snapshot=type][,driver=type][,file=name]

## 下面是具体使用场景展示 ##
# step1: 查看 KY-vxlan100-A 虚拟机信息
# 只有系统盘
# step2: 对 KY-vxlan100-A 虚拟机创建快照
# 查看虚拟机 /root/snap.txt 中内容
# 创建快照
# 查看快照列表
# step3: 在 KY-vxlan100-A 内操作文件
# 查看 /root/snap.txt文件内容
# step4: 执行快照还原,并查看 /root/snap.txt 中内容
# step5: 为磁盘挂载新的数据盘
# step6: 在虚拟机内格式化新加磁盘,挂载,并创建文件
# step7: 对虚拟机创建快照
# step8: 列出可用快照
# step9: 将新加数据盘卸载,并执行快照还原
# step10: 查看此时虚拟机磁盘列表,以及挂载文件夹内的文件
# step11: 将数据盘文件修改名字,重新执行快照还原
# step12: 查看磁盘的快照信息





快照创建与还原,参考文档:
1.http://www.it165.net/os/html/201309/6189.html             # 快照-实践篇
2.http://blog.chinaunix.net/uid-20794164-id-3989713.html    # 快照-理论篇
3.http://blog.chinaunix.net/uid-20940095-id-4752643.html    # openstack中的虚拟机快照功能
