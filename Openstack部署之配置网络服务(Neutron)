### 配置网络服务 ###
第0部分:  网络概念
第1部分:  网络2层插件
第2部分:  测试:创建虚拟机

########################################################## NO.0 网络概念 ###################################################################
(TODO)
OpenStack Networking (neutron) manages all of the networking facets for the Virtual Networking Infrastructure (VNI) and the access layer 
aspects of the Physical Networking Infrastructure (PNI) in your OpenStack environment. OpenStack Networking allows tenants to create 
advanced virtual network topologies including services such as firewalls, load balancers, and virtual private networks (VPNs).

Networking provides the following object abstractions: networks, subnets, and routers. Each has functionality that mimics its physical 
counterpart: networks contain subnets, and routers route traffic between different subnet and networks.

Any given Networking set up has at least one external network. This network, unlike the other networks, is not merely a virtually defined
network. Instead, it represents the view into a slice of the external network that is accessible outside the OpenStack installation. IP 
addresses on the Networking external network are accessible by anybody physically on the outside network. Because this network merely 
represents a slice of the outside network, DHCP is disabled on this network.

In addition to external networks, any Networking set up has one or more internal networks. These software-defined networks connect directly
to the VMs. Only the VMs on any given internal network, or those on subnets connected through interfaces to a similar router, can access 
VMs connected to that network directly.

For the outside network to access VMs, and vice versa, routers between the networks are needed. Each router has one gateway that is 
connected to a network and many interfaces that are connected to subnets. Like a physical router, subnets can access machines on other 
subnets that are connected to the same router, and machines can access the outside network through the gateway for the router.

Additionally, you can allocate IP addresses on external networks to ports on the internal network. Whenever something is connected to a 
subnet, that connection is called a port. You can associate external network IP addresses with ports to VMs. This way, entities on the 
outside network can access VMs.

Networking also supports security groups. Security groups enable administrators to define firewall rules in groups. A VM can belong to 
one or more security groups, and Networking applies the rules in those security groups to block or unblock ports, port ranges, or traffic
types for that VM.

Each plug-in that Networking uses has its own concepts. While not vital to operating Networking, understanding these concepts can help you
set up Networking. All Networking installations use a core plug-in and a security group plug-in (or just the No-Op security group plug-in).
Additionally, Firewall-as-a-service (FWaaS) and Load-balancing-as-a-service (LBaaS) plug-ins are available.

########################################################## NO.1 网络2层插件 ################################################################
理论部分:(TODO)
实践部分:
Part01: 配置主控节点
1.使用root用户登录数据库创建neutron数据库,赋权
[root@controller ~]# mysql -uroot -p
Enter password: 1428101ae612a0110bb9
MariaDB [(none)]> CREATE DATABASE neutron;
MariaDB [(none)]> GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' IDENTIFIED BY 'f79719d688c353d0703c';
MariaDB [(none)]> GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' IDENTIFIED BY 'f79719d688c353d0703c';
MariaDB [(none)]> FLUSH PRIVILEGES;
MariaDB [(none)]> quit

2.使用Identity服务为网络创建凭据
    a.创建neutron用户:
    [root@controller ~]# source keystonerc_admin 
    [root@controller ~(keystonerc_admin)]$ keystone user-create --name neutron --pass fd659cbfdc98a28bed5b --email neutron@qqvps.com
    +----------+----------------------------------+
    | Property |              Value               |
    +----------+----------------------------------+
    |  email   |        neutron@qqvps.com         |
    | enabled  |               True               |
    |    id    | 1481c48772d942399b54b3d841aa4957 |
    |   name   |             neutron              |
    | username |             neutron              |
    +----------+----------------------------------+
    b.将新用户分配到service租户以及admin角色:
    [root@controller ~(keystonerc_admin)]$ keystone user-role-add --user neutron --tenant service --role admin
    c.创建neutron服务:
    [root@controller ~(keystonerc_admin)]$ keystone service-create --name neutron --type network --description "OpenStack Networking"
    +-------------+----------------------------------+
    |   Property  |              Value               |
    +-------------+----------------------------------+
    | description |       OpenStack Networking       |
    |   enabled   |               True               |
    |      id     | 4e9761b48f944d4a9fbecf0aceffe7d1 |
    |     name    |             neutron              |
    |     type    |             network              |
    +-------------+----------------------------------+
    d.创建服务端点
    [root@controller ~(keystonerc_admin)]$ keystone service-list | awk '/ network / {print $2}'
    4e9761b48f944d4a9fbecf0aceffe7d1
    [root@controller ~(keystonerc_admin)]$ keystone endpoint-create --service-id  4e9761b48f944d4a9fbecf0aceffe7d1 
                                                                    --publicurl   http://controller:9696 
                                                                    --adminurl    http://controller:9696 
                                                                    --internalurl http://controller:9696
    +-------------+----------------------------------+
    |   Property  |              Value               |
    +-------------+----------------------------------+
    |   adminurl  |      http://controller:9696      |
    |      id     | 34533dab81f84e8ab65e6717dabb2fb0 |
    | internalurl |      http://controller:9696      |
    |  publicurl  |      http://controller:9696      |
    |    region   |            regionOne             |
    |  service_id | 4e9761b48f944d4a9fbecf0aceffe7d1 |
    +-------------+----------------------------------+

3.安装网络组件
[root@controller ~]$ yum install -y openstack-neutron.noarch openstack-neutron-ml2.noarch python-neutronclient.noarch

4.配置neutron server组件
    a.配置网络服务使用数据库:
    [root@controller ~]$ openstack-config --set /etc/neutron/neutron.conf database connection \
                                                                mysql://neutron:f79719d688c353d0703c@controller/neutron
    b.配置neutron使用Identity服务认证:
    [root@controller ~]$ openstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone
    [root@controller ~]$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_uri http://controller:5000
    [root@controller ~]$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_host controller
    [root@controller ~]$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_protocol http
    [root@controller ~]$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_port 35357
    [root@controller ~]$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken admin_tenant_name service
    [root@controller ~]$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken admin_user neutron
    [root@controller ~]$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken admin_password fd659cbfdc98a28bed5b
    
    c.配置网络服务使用rabbitmq消息队列:
    [root@controller ~]$ openstack-config --set /etc/neutron/neutron.conf DEFAULT rpc_backend neutron.openstack.common.rpc.impl_kombu
    [root@controller ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_host 10.160.0.116
    [root@controller ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_password guest
    [root@controller ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_port 5672
    [root@controller ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_hosts 10.160.0.116:5672
    [root@controller ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_userid guest
    [root@controller ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_virtual_host /
    [root@controller ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_ha_queues False
    [root@controller ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_use_ssl False
    
    d.配置neutron通知nova关于网络拓扑变动:
    [root@controller ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_status_changes True
    [root@controller ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_data_changes True
    [root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/neutron/neutron.conf DEFAULT nova_url http://controller:8774/v2
    [root@controller ~(keystonerc_admin)]$ openstack-config --set /etc/neutron/neutron.conf DEFAULT nova_admin_username nova
    [root@controller ~(keystonerc_admin)]$ keystone tenant-list | awk '/ service / { print $2 }'
    3fb14bc2d9f149e18991c7bd0f67b7f6
    [root@controller ~]$ openstack-config --set /etc/neutron/neutron.conf DEFAULT nova_admin_tenant_id 3fb14bc2d9f149e18991c7bd0f67b7f6
    [root@controller ~]$ openstack-config --set /etc/neutron/neutron.conf DEFAULT nova_admin_password 0275aa48b1e0a313bced
    [root@controller ~]$ openstack-config --set /etc/neutron/neutron.conf DEFAULT nova_admin_auth_url http://controller:35357/v2.0
    
    e.配置使用ml2组件以及相关服务
    [root@controller ~]$ openstack-config --set /etc/neutron/neutron.conf DEFAULT core_plugin ml2
    [root@controller ~]$ openstack-config --set /etc/neutron/neutron.conf DEFAULT service_plugins router
    
    f.开启调试模式以辅助troubleshooting
    [root@controller ~]$ openstack-config --set /etc/neutron/neutron.conf DEFAULT verbose  True
    
5.配置ml2插件
[root@controller ~]$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 type_drivers vxlan
[root@controller ~]$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 mechanism_drivers openvswitch
[root@controller ~]$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 tenant_network_types vxlan
[root@controller ~]$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_vxlan vni_ranges 1:1000
[root@controller ~]$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup enable_security_group True
[root@controller ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup firewall_driver \
                                                         neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
6.配置计算服务使用网络组件
[root@controller ~]# openstack-config --set /etc/nova/nova.conf DEFAULT network_api_class nova.network.neutronv2.api.API
[root@controller ~]# openstack-config --set /etc/nova/nova.conf DEFAULT neutron_url http://controller:9696
[root@controller ~]# openstack-config --set /etc/nova/nova.conf DEFAULT neutron_auth_strategy keystone
[root@controller ~]# openstack-config --set /etc/nova/nova.conf DEFAULT neutron_admin_tenant_name service
[root@controller ~]# openstack-config --set /etc/nova/nova.conf DEFAULT neutron_admin_username neutron
[root@controller ~]# openstack-config --set /etc/nova/nova.conf DEFAULT neutron_admin_password fd659cbfdc98a28bed5b
[root@controller ~]# openstack-config --set /etc/nova/nova.conf DEFAULT neutron_admin_auth_url http://controller:35357/v2.0
[root@controller ~]# openstack-config --set /etc/nova/nova.conf DEFAULT linuxnet_interface_driver \
                                                                     nova.network.linux_net.LinuxOVSInterfaceDriver
[root@controller ~]# openstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver
[root@controller ~]# openstack-config --set /etc/nova/nova.conf DEFAULT security_group_api neutron

# 使用neutron的fwaas,通过NoopFirewallDriver禁用nova的防火墙服务
[root@controller ~]# openstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver
[root@controller ~]# openstack-config --set /etc/nova/nova.conf DEFAULT security_group_api neutron

7.最后的安装
    a.创建ml2_conf.ini 到 /etc/neutron/plugin.ini 的软链接:
    [root@controller ~]# ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini
    [root@controller ~]# ll /etc/neutron/plugin.ini 
    lrwxrwxrwx. 1 root root 37 Jul 25 15:46 /etc/neutron/plugin.ini -> /etc/neutron/plugins/ml2/ml2_conf.ini
    
    b.重启计算服务:
    [root@controller ~]# for service in {api,conductor,scheduler};do systemctl restart openstack-nova-${service} ;done
    [root@controller ~]# for service in {api,conductor,scheduler};do systemctl status openstack-nova-${service} ;done
    c.启动 neutron server,并设置开机启动:
    [root@controller ~]# systemctl start   neutron-server
    [root@controller ~]# systemctl status  neutron-server
    [root@controller ~]# systemctl enable  neutron-server

Part02: 配置网络节点
1.开启特定的内核网络功能
[root@network ~]# sysctl -w net.ipv4.ip_forward=1 && echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
[root@network ~]# sysctl -w net.ipv4.conf.all.rp_filter=0 && echo "net.ipv4.conf.all.rp_filter=0" >> /etc/sysctl.conf
[root@network ~]# sysctl -w net.ipv4.conf.default.rp_filter=0 && echo "net.ipv4.conf.default.rp_filter=0" >> /etc/sysctl.conf
[root@network ~]# sysctl -w net.bridge.bridge-nf-call-arptables=1 && echo "net.bridge.bridge-nf-call-arptables=1" >> /etc/sysctl.conf
[root@network ~]# sysctl -w net.bridge.bridge-nf-call-iptables=1 && echo "net.bridge.bridge-nf-call-iptables=1" >> /etc/sysctl.conf
[root@network ~]# sysctl -w net.bridge.bridge-nf-call-ip6tables=1 && echo "net.bridge.bridge-nf-call-ip6tables=1" >> /etc/sysctl.conf
# note:?参数详解(TODO)?

2.立即启用上述参数修改
[root@network ~]# sysctl -p

3.安装网络节点的网络服务组件
[root@network ~]# yum install -y openstack-neutron openstack-neutron-ml2 openstack-neutron-openvswitch

4.配置网络通用组件
    a.配置neutron使用Identity服务认证:
    [root@network ~]$ openstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone
    [root@network ~]$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_uri http://controller:5000
    [root@network ~]$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_host controller
    [root@network ~]$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_protocol http
    [root@network ~]$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_port 35357
    [root@network ~]$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken admin_tenant_name service
    [root@network ~]$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken admin_user neutron
    [root@network ~]$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken admin_password fd659cbfdc98a28bed5b
    b.配置网络服务使用rabbitmq消息队列:
    [root@network ~]$ openstack-config --set /etc/neutron/neutron.conf DEFAULT rpc_backend neutron.openstack.common.rpc.impl_kombu
    [root@network ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_host 10.160.0.116
    [root@network ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_password guest
    [root@network ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_port 5672
    [root@network ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_hosts 10.160.0.116:5672
    [root@network ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_userid guest
    [root@network ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_virtual_host /
    [root@network ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_ha_queues False
    [root@network ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_use_ssl False
    c.配置使用ml2组件以及相关服务
    [root@network ~]$ openstack-config --set /etc/neutron/neutron.conf DEFAULT core_plugin ml2
    [root@network ~]$ openstack-config --set /etc/neutron/neutron.conf DEFAULT service_plugins router
    d.开启调试模式以辅助troubleshooting
    [root@network ~]$ openstack-config --set /etc/neutron/neutron.conf DEFAULT verbose  True
    
5.配置L3 Agent组件
[root@network ~]# openstack-config --set /etc/neutron/l3_agent.ini DEFAULT interface_driver \
                                                                               neutron.agent.linux.interface.OVSInterfaceDriver
[root@network ~]# openstack-config --set /etc/neutron/l3_agent.ini DEFAULT use_namespaces True

6.配置DHCP Agent组件
    a.配置dhcp agent的 interface_driver,dhcp_driver,以及use_namespaces与否
    [root@network ~]# openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT interface_driver \
                                                                                 neutron.agent.linux.interface.OVSInterfaceDriver
    [root@network ~]# openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT dhcp_driver neutron.agent.linux.dhcp.Dnsmasq
    [root@network ~]# openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT use_namespaces True
    b.调整 dnsmasq服务的MTU特性
    [root@network ~]# openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT dnsmasq_config_file /etc/neutron/dnsmasq-neutron.conf
    # mtu1454使用于大多数系统
    [root@network ~]# echo "dhcp-option-force=26,1454" >> /etc/neutron/dnsmasq-neutron.conf
    [root@network ~]# for dnsmasq_pid in `ps aux | grep dnsmasq |awk '{print $2}'`;do kill -9 $dnsmasq_pid;done
    
6.配置Metadata Agent组件
    a.在网络节点上执行:
    [root@network ~]# openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT auth_url http://controller:5000/v2.0
    [root@network ~]# openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT auth_region regionOne
    [root@network ~]# openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT admin_tenant_name service
    [root@network ~]# openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT admin_user neutron
    [root@network ~]# openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT admin_password fd659cbfdc98a28bed5b
    [root@network ~]# openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT nova_metadata_ip controller
    # 生成 METADATA_SHARED_SECRET
    [root@network ~]# openssl rand -hex 10
    370be9b49a4dd9878b37
    [root@network ~]# openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT metadata_proxy_shared_secret 370be9b49a4dd9878b37
    b.在主控节点上执行
    [root@controller ~]# openstack-config --set /etc/nova/nova.conf DEFAULT service_neutron_metadata_proxy true
    [root@controller ~]# openstack-config --set /etc/nova/nova.conf DEFAULT neutron_metadata_proxy_shared_secret 370be9b49a4dd9878b37
    [root@controller ~]# systemctl restart openstack-nova-api

7.配置ml2插件
[root@network ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 type_drivers vxlan
[root@network ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 tenant_network_types vxlan
[root@network ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 mechanism_drivers openvswitch
[root@network ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_vxlan vni_ranges 1:1000
[root@network ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs enable_tunneling True
[root@network ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs tunnel_type vxlan
[root@network ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs local_ip 172.172.172.149
[root@network ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup firewall_driver \
                                                              neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
[root@network ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup enable_security_group True
# 如下设置官方没提但是却是自动创建 vxlan 隧道必须的
# 参考文档:http://www.qlogic.com/solutions/Documents/UsersGuide_OpenStack_VXLAN.pdf
[root@network ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs tenant_network_type vxlan
[root@network ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs tunnel_bridge br-tun
[root@network ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs integration_bridge br-int
[root@network ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs tunnel_id_ranges 65535:69999
[root@network ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini agent tunnel_types vxlan
[root@network ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini agent vxlan_udp_port 4789
[root@network ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini agent l2_population False

8.配置ovs服务
    a.启动openvswitch并设置开机启动
    [root@network ~]# systemctl status openvswitch
    [root@network ~]# systemctl enable  openvswitch
    b.创建br-int
    [root@network ~]# ovs-vsctl add-br br-int
    c.创建br-ex
    [root@network ~]# ovs-vsctl add-br br-ex
    d.将br-ex连接到打vlan而不配置ip的网络设备
    [root@network ~]# ip link add link ens192 name ens192.610 type vlan id 610  
    [root@network ~]# ip link set ens192.610 up
    [root@network ~]# ovs-vsctl add-port br-ex ens192.610
    e.测试关闭GRO
    [root@network ~]# ethtool -K ens192.610 gro off

9.结束安装
    a.创建到 ml2_conf.ini 的软链接
    [root@network ~]# ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini
    # 并替换服务启动脚本中的 plugin.ini
    # 默认使用 
    # 如下: ExecStart=/usr/bin/neutron-openvswitch-agent --config-file /usr/share/neutron/neutron-dist.conf 
    #                    --config-file /etc/neutron/neutron.conf 
    #                    --config-file /etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini 
    #                    --log-file /var/log/neutron/openvswitch-agent.log
    # 使用 sed 替换掉 ovs_neutron_plugin.ini
    # 注意: 使用 systemd 管理的服务,脚本路径在 /usr/lib/systemd/system/ 下
    [root@network ~]# sed -i 's,plugins/openvswitch/ovs_neutron_plugin.ini,plugin.ini,g'  \
                                           /usr/lib/systemd/system/neutron-openvswitch-agent.service
    b.启动各个服务并设置开机启动
    # 在修改systemctl管理neutron-openvswitch-agent的脚本之后,请显式地enable该service,然后允许其创建对应软链接 
    [root@network ~]# systemctl enable neutron-openvswitch-agent
    [root@network ~]# systemctl start neutron-openvswitch-agent
    [root@network ~]# systemctl status neutron-l3-agent
    [root@network ~]# systemctl enable neutron-l3-agent
    [root@network ~]# systemctl start  neutron-dhcp-agent
    [root@network ~]# systemctl enable neutron-dhcp-agent
    [root@network ~]# systemctl start neutron-metadata-agent
    [root@network ~]# systemctl enable neutron-metadata-agent
    
Part03: 配置计算节点
1.设置网络内核参数并持久化入配置文件
[root@compute ~]# sysctl -w net.ipv4.ip_forward=1 && echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
[root@compute ~]# sysctl -w net.ipv4.conf.all.rp_filter=0 && echo "net.ipv4.conf.all.rp_filter=0" >> /etc/sysctl.conf
[root@compute ~]# sysctl -w net.ipv4.conf.default.rp_filter=0 && echo "net.ipv4.conf.default.rp_filter=0" >> /etc/sysctl.conf
[root@compute ~]# sysctl -w net.bridge.bridge-nf-call-arptables=1 && echo "net.bridge.bridge-nf-call-arptables=1" >> /etc/sysctl.conf
[root@compute ~]# sysctl -w net.bridge.bridge-nf-call-iptables=1 && echo "net.bridge.bridge-nf-call-iptables=1" >> /etc/sysctl.conf
[root@compute ~]# sysctl -w net.bridge.bridge-nf-call-ip6tables=1 && echo "net.bridge.bridge-nf-call-ip6tables=1" >> /etc/sysctl.conf
# 立即应用内核参数
[root@compute ~]# sysctl -p

2.安装网络组件
[root@compute ~]# yum install -y openstack-neutron-ml2 openstack-neutron-openvswitch

3.配置网络通用组件
    a.配置网络服务采用Identity服务认证
    [root@compute ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone
    [root@compute ~]# openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_uri http://controller:5000
    [root@compute ~]# openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_host controller
    [root@compute ~]# openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_protocol http
    [root@compute ~]# openstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_port 35357
    [root@compute ~]# openstack-config --set /etc/neutron/neutron.conf keystone_authtoken admin_tenant_name service
    [root@compute ~]# openstack-config --set /etc/neutron/neutron.conf keystone_authtoken admin_user neutron
    [root@compute ~]# openstack-config --set /etc/neutron/neutron.conf keystone_authtoken admin_password fd659cbfdc98a28bed5b
    
    b.配置网络服务使用rabbitmq消息队列
    [root@compute ~]$ openstack-config --set /etc/neutron/neutron.conf DEFAULT rpc_backend neutron.openstack.common.rpc.impl_kombu
    [root@compute ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_host 10.160.0.116
    [root@compute ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_password guest
    [root@compute ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_port 5672
    [root@compute ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_hosts 10.160.0.116:5672
    [root@compute ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_userid guest
    [root@compute ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_virtual_host /
    [root@compute ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_ha_queues False
    [root@compute ~]# openstack-config --set /etc/neutron/neutron.conf DEFAULT rabbit_use_ssl False
    
    c.配置网络服务使用ml2组件及其相关组件
    [root@compute ~]$ openstack-config --set /etc/neutron/neutron.conf DEFAULT core_plugin ml2
    [root@compute ~]$ openstack-config --set /etc/neutron/neutron.conf DEFAULT service_plugins router
    
4.配置ML2组件
[root@compute ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 type_drivers vxlan
[root@compute ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 tenant_network_types vxlan
[root@compute ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 mechanism_drivers openvswitch
[root@compute ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_vxlan vni_ranges 1:1000
[root@compute ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs enable_tunneling True
[root@compute ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs tunnel_type vxlan
[root@compute ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs local_ip 172.172.172.117
[root@compute ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup firewall_driver \
                                                              neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
[root@network ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup enable_security_group True
# 如下设置官方没提但是却是自动创建 vxlan 隧道必须的
# 参考文档:http://www.qlogic.com/solutions/Documents/UsersGuide_OpenStack_VXLAN.pdf
[root@compute ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs tenant_network_type vxlan
[root@compute ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs tunnel_bridge br-tun
[root@compute ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs integration_bridge br-int
[root@compute ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs tunnel_id_ranges 65535:69999
[root@compute ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini agent tunnel_types vxlan
[root@compute ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini agent vxlan_udp_port 4789
[root@compute ~]# openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini agent l2_population False


5.配置openvswitch服务
    a.启动openvswitch并设置开机启动
    [root@compute ~]# systemctl start openvswitch && systemctl enable openvswitch
    b.添加集成网桥
    [root@compute ~]# ovs-vsctl add-br br-int
    
6.配置计算服务使用网络服务
[root@compute ~]# openstack-config --set /etc/nova/nova.conf DEFAULT network_api_class nova.network.neutronv2.api.API
[root@compute ~]# openstack-config --set /etc/nova/nova.conf DEFAULT neutron_url http://controller:9696
[root@compute ~]# openstack-config --set /etc/nova/nova.conf DEFAULT neutron_auth_strategy keystone
[root@compute ~]# openstack-config --set /etc/nova/nova.conf DEFAULT neutron_admin_tenant_name service
[root@compute ~]# openstack-config --set /etc/nova/nova.conf DEFAULT neutron_admin_username neutron
[root@compute ~]# openstack-config --set /etc/nova/nova.conf DEFAULT neutron_admin_password fd659cbfdc98a28bed5b
[root@compute ~]# openstack-config --set /etc/nova/nova.conf DEFAULT neutron_admin_auth_url http://controller:35357/v2.0
[root@compute ~]# openstack-config --set /etc/nova/nova.conf DEFAULT linuxnet_interface_driver \
                                                                     nova.network.linux_net.LinuxOVSInterfaceDriver
[root@compute ~]# openstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver
[root@compute ~]# openstack-config --set /etc/nova/nova.conf DEFAULT security_group_api neutron
    
7.结束安装
    a.创建ml2_conf.ini到 /etc/neutron.plugin.ini的软链接
    [root@compute ~]# ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini
    b.替换(neutron-openvswitch-agent)服务启动脚本中应用的插件文件
    [root@compute ~]# sed -i 's,plugins/openvswitch/ovs_neutron_plugin.ini,plugin.ini,g' \
                                                    /usr/lib/systemd/system/neutron-openvswitch-agent.service
    c.重启openstack-nova-compute服务
    [root@compute ~]# systemctl restart openstack-nova-compute
    d.设置开机启动neutron-openvswitch-agent,并启动之
    [root@compute ~]# systemctl restart neutron-openvswitch-agent

Part04: 创建初始网络
1.创建公网资源池
[root@controller ~]# source keystonerc_admin
[root@controller ~(keystonerc_admin)]$ neutron net-create ext-net --shared --router:external=true
Created a new network:
+---------------------------+--------------------------------------+
| Field                     | Value                                |
+---------------------------+--------------------------------------+
| admin_state_up            | True                                 |
| id                        | 14a198f8-133d-40be-bbc0-865b0c66a908 |
| name                      | ext-net                              |
| provider:network_type     | vxlan                                |
| provider:physical_network |                                      |
| provider:segmentation_id  | 1                                    |
| router:external           | True                                 |
| shared                    | True                                 |
| status                    | ACTIVE                               |
| subnets                   |                                      |
| tenant_id                 | e068b28f4d09487a91df3f1e02aa645f     |
+---------------------------+--------------------------------------+

2.为公共网络创建子网
[root@controller ~(keystonerc_admin)]$ neutron subnet-create ext-net --name ext-subnet --disable-dhcp \
                                            --allocation-pool start=10.160.0.151,end=10.160.0.161 \
                                            --gateway 10.160.0.1 10.160.0.0/16
Created a new subnet:
+------------------+--------------------------------------------------+
| Field            | Value                                            |
+------------------+--------------------------------------------------+
| allocation_pools | {"start": "10.160.0.151", "end": "10.160.0.161"} |
| cidr             | 10.160.0.0/16                                    |
| dns_nameservers  |                                                  |
| enable_dhcp      | False                                            |
| gateway_ip       | 10.160.0.1                                       |
| host_routes      |                                                  |
| id               | ee927adf-7a4e-4a9a-844f-5f3f850b33dd             |
| ip_version       | 4                                                |
| name             | ext-subnet                                       |
| network_id       | 14a198f8-133d-40be-bbc0-865b0c66a908             |
| tenant_id        | e068b28f4d09487a91df3f1e02aa645f                 |
+------------------+--------------------------------------------------+


########################################################## NO.2 测试:创建虚拟机 ##########################################################
Part01:生成key pair
1.切换到系统用户demo
[root@controller ~]# cat keystonerc_demo 
export OS_USERNAME=demo
export OS_TENANT_NAME=demo
export OS_AUTH_URL=http://controller:35357/v2.0
export PS1='[\u@\h \W(keystonerc_demo)]$ '
export OS_PASSWORD=22eb630cad4785bfdc81
[root@controller ~]# source keystonerc_demo

2.生成sshkey
[root@controller ~(keystonerc_demo)]$ ssh-keygen 
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa): 
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /root/.ssh/id_rsa.
Your public key has been saved in /root/.ssh/id_rsa.pub.
The key fingerprint is:
99:95:09:56:eb:ad:c7:b0:85:26:f6:e1:20:2c:a9:e0 root@controller
The key's randomart image is:
+--[ RSA 2048]----+
|        o..      |
|       . . +     |
|          =      |
|     o   = o     |
|.   o o S * o    |
|.. . . o * B     |
| E.       = o    |
|           .     |
|                 |
+-----------------+

3.添加ssh key公钥到openstack环境
[root@controller ~(keystonerc_demo)]$ nova keypair-add --pub-key /root/.ssh/id_rsa.pub demo-key

4.查看公钥
[root@controller ~(keystonerc_demo)]$ nova keypair-list
+----------+-------------------------------------------------+
| Name     | Fingerprint                                     |
+----------+-------------------------------------------------+
| demo-key | 99:95:09:56:eb:ad:c7:b0:85:26:f6:e1:20:2c:a9:e0 |
+----------+-------------------------------------------------+

Part02:启动实例
1.创建套餐
# 系统初始化时已经默认添加5种套餐
[root@controller ~(keystonerc_demo)]$ nova flavor-list
+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+
| ID | Name      | Memory_MB | Disk | Ephemeral | Swap | VCPUs | RXTX_Factor | Is_Public |
+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+
| 1  | m1.tiny   | 512       | 1    | 0         |      | 1     | 1.0         | True      |
| 2  | m1.small  | 2048      | 20   | 0         |      | 1     | 1.0         | True      |
| 3  | m1.medium | 4096      | 40   | 0         |      | 2     | 1.0         | True      |
| 4  | m1.large  | 8192      | 80   | 0         |      | 4     | 1.0         | True      |
| 5  | m1.xlarge | 16384     | 160  | 0         |      | 8     | 1.0         | True      |
+----+-----------+-----------+------+-----------+------+-------+-------------+-----------+

2.上传或查询现有可用镜像
# 部署镜像服务后测试阶段上传cirros
[root@controller ~(keystonerc_demo)]$ glance image-list
+--------------------------------------+--------+-------------+------------------+----------+--------+
| ID                                   | Name   | Disk Format | Container Format | Size     | Status |
+--------------------------------------+--------+-------------+------------------+----------+--------+
| ba8251cc-618b-48c1-b15d-583032777f56 | cirros | qcow2       | bare             | 13167616 | active |
+--------------------------------------+--------+-------------+------------------+----------+--------+

3.创建租户网络,子网
[root@controller ~(keystonerc_demo)]$ neutron net-create net-demo 
Created a new network:
+----------------+--------------------------------------+
| Field          | Value                                |
+----------------+--------------------------------------+
| admin_state_up | True                                 |
| id             | aed5bdd3-b89c-443b-a83d-8aa09fb77e0b |
| name           | net-demo                             |
| shared         | False                                |
| status         | ACTIVE                               |
| subnets        |                                      |
| tenant_id      | ce0b702330f74917a4f864af3df4b322     |
+----------------+--------------------------------------+

[root@controller ~(keystonerc_demo)]$ neutron subnet-create net-demo --name subnet-demo \
                                              --disable-dhcp --allocation-pool start=172.172.172.100,end=172.172.172.100 \
                                              --gateway 172.172.172.1 172.172.172.0/24
Created a new subnet:
+------------------+--------------------------------------------------------+
| Field            | Value                                                  |
+------------------+--------------------------------------------------------+
| allocation_pools | {"start": "172.172.172.100", "end": "172.172.172.100"} |
| cidr             | 172.172.172.0/24                                       |
| dns_nameservers  |                                                        |
| enable_dhcp      | False                                                  |
| gateway_ip       | 172.172.172.1                                          |
| host_routes      |                                                        |
| id               | 39052935-e31e-4979-bcda-d98dd8091c49                   |
| ip_version       | 4                                                      |
| name             | subnet-demo                                            |
| network_id       | aed5bdd3-b89c-443b-a83d-8aa09fb77e0b                   |
| tenant_id        | ce0b702330f74917a4f864af3df4b322                       |
+------------------+--------------------------------------------------------+

4.创建安全组
# 使用系统初始安全组
[root@controller ~(keystonerc_demo)]$ nova secgroup-list
+--------------------------------------+---------+-------------+
| Id                                   | Name    | Description |
+--------------------------------------+---------+-------------+
| 9e24d93b-e894-433b-8446-03b44c171ba7 | default | default     |
+--------------------------------------+---------+-------------+

# 添加安全组规则允许远程访问
# http://docs.openstack.org/icehouse/install-guide/install/yum/content/launch-instance-nova.html#launch-instance-nova-remoteaccess
(TODO)

5.启动实例
[root@controller ~(keystonerc_demo)]$ nova boot --flavor m1.small --image ba8251cc-618b-48c1-b15d-583032777f56 \
                               --nic net-id=aed5bdd3-b89c-443b-a83d-8aa09fb77e0b --security-group 9e24d93b-e894-433b-8446-03b44c171ba7 \
                               --key-name demo-key demo-instance
+--------------------------------------+-----------------------------------------------+
| Property                             | Value                                         |
+--------------------------------------+-----------------------------------------------+
| OS-DCF:diskConfig                    | MANUAL                                        |
| OS-EXT-AZ:availability_zone          | nova                                          |
| OS-EXT-STS:power_state               | 0                                             |
| OS-EXT-STS:task_state                | scheduling                                    |
| OS-EXT-STS:vm_state                  | building                                      |
| OS-SRV-USG:launched_at               | -                                             |
| OS-SRV-USG:terminated_at             | -                                             |
| accessIPv4                           |                                               |
| accessIPv6                           |                                               |
| adminPass                            | WEreEMP3zWaq                                  |
| config_drive                         |                                               |
| created                              | 2016-07-26T10:36:10Z                          |
| flavor                               | m1.small (2)                                  |
| hostId                               |                                               |
| id                                   | e2905f73-45e3-4fcd-a478-a1d6b6ba5f36          |
| image                                | cirros (ba8251cc-618b-48c1-b15d-583032777f56) |
| key_name                             | demo-key                                      |
| metadata                             | {}                                            |
| name                                 | demo-instance                                 |
| os-extended-volumes:volumes_attached | []                                            |
| progress                             | 0                                             |
| security_groups                      | 9e24d93b-e894-433b-8446-03b44c171ba7          |
| status                               | BUILD                                         |
| tenant_id                            | ce0b702330f74917a4f864af3df4b322              |
| updated                              | 2016-07-26T10:36:10Z                          |
| user_id                              | be2ccbd63de7460dbd556c5b5f99e9d7              |
+--------------------------------------+-----------------------------------------------+

[root@controller ~(keystonerc_demo)]$ nova list
+--------------------------------------+---------------+--------+------------+-------------+--------------------------+
| ID                                   | Name          | Status | Task State | Power State | Networks                 |
+--------------------------------------+---------------+--------+------------+-------------+--------------------------+
| e2905f73-45e3-4fcd-a478-a1d6b6ba5f36 | demo-instance | ACTIVE | -          | Running     | net-demo=172.172.172.100 |
+--------------------------------------+---------------+--------+------------+-------------+--------------------------+








